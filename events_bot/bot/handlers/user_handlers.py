from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext
from events_bot.database.services import UserService, CategoryService, PostService, LikeService, CityService
from events_bot.bot.states import UserStates
from events_bot.bot.keyboards import get_main_keyboard, get_category_selection_keyboard, get_city_keyboard
from events_bot.utils import get_clean_category_string
from events_bot.bot.keyboards.notification_keyboard import get_post_notification_keyboard
from events_bot.bot.handlers.feed_handlers import show_liked_page_from_animation, format_liked_list
from events_bot.bot.keyboards.feed_keyboard import get_liked_list_keyboard
import logfire
import os
import asyncio
from aiogram.exceptions import TelegramForbiddenError, TelegramRetryAfter

LIKED_GIF_ID = os.getenv("LIKED_GIF_ID")
POSTS_PER_PAGE = 5
router = Router()

# ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID)
ADMIN_USER_ID = int(os.getenv("ADMIN_USER_ID", 0))


def register_user_handlers(dp: Router):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    dp.include_router(router)

# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞/—Å–º–µ–Ω—ã –≥–æ—Ä–æ–¥–∞ ---

@router.callback_query(UserStates.waiting_for_city, F.data.startswith("city_"))
async def process_city_selection(callback: CallbackQuery, state: FSMContext, db):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä)"""
    city_id = int(callback.data.split("_")[1])
    data = await state.get_data()
    selected_ids = data.get("selected_cities", [])

    if city_id in selected_ids:
        selected_ids.remove(city_id)
    else:
        selected_ids.append(city_id)
    await state.update_data(selected_cities=selected_ids)

    all_cities = await CityService.get_all_cities(db)
    await callback.message.edit_reply_markup(
        reply_markup=get_city_keyboard(all_cities, selected_ids)
    )
    await callback.answer()


@router.callback_query(UserStates.waiting_for_city, F.data == "user_city_select_all")
async def process_select_all_cities(callback: CallbackQuery, state: FSMContext, db):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ' –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤"""
    all_cities = await CityService.get_all_cities(db)
    all_city_ids = [c.id for c in all_cities]

    data = await state.get_data()
    selected_ids = data.get("selected_cities", [])

    if len(selected_ids) == len(all_city_ids):
        new_selection = []
        await callback.answer("–í—Å–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã —Å–Ω—è—Ç—ã")
    else:
        new_selection = all_city_ids
        await callback.answer("–í—Å–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –≤—ã–±—Ä–∞–Ω—ã")

    await state.update_data(selected_cities=new_selection)
    await callback.message.edit_reply_markup(
        reply_markup=get_city_keyboard(all_cities, new_selection)
    )


@router.callback_query(UserStates.waiting_for_city, F.data == "confirm_cities")
async def confirm_city_selection(callback: CallbackQuery, state: FSMContext, db):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–æ–≤"""
    data = await state.get_data()
    selected_ids = data.get("selected_cities", [])
    if not selected_ids:
        await callback.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç", show_alert=True)
        return

    await UserService.select_cities(db, callback.from_user.id, selected_ids)
    
    selected_cities = await CityService.get_cities_by_ids(db, selected_ids)
    city_names = ", ".join([c.name for c in selected_cities])
    
    await state.update_data(selected_cities=[]) # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ

    categories = await CategoryService.get_all_categories(db)
    user_categories = await UserService.get_user_categories(db, callback.from_user.id)
    selected_cat_ids = [cat.id for cat in user_categories]

    text_to_send = (
        f"–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –≤—ã–±—Ä–∞–Ω—ã: {city_names}\n\n"
        f"‚≠êÔ∏è –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –¥–ª—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏:"
    )
    keyboard = get_category_selection_keyboard(categories, selected_cat_ids)
    
    try:
        await callback.message.delete()
    except Exception:
        pass
    
    await callback.message.answer(text=text_to_send, reply_markup=keyboard)

    await state.set_state(UserStates.waiting_for_categories)
    await callback.answer()


@router.callback_query(F.data == "change_city")
async def change_city_callback(callback: CallbackQuery, state: FSMContext, db):
    """–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É"""
    all_cities = await CityService.get_all_cities(db)
    user_cities = await UserService.get_user_cities(db, callback.from_user.id)
    selected_ids = [c.id for c in user_cities]
    
    await state.update_data(selected_cities=selected_ids)

    try:
        await callback.message.delete()
    except Exception:
        pass
    
    await callback.message.answer(
        "–û –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö –≤ –∫–∞–∫–∏—Ö —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞—Ö –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–Ω–∞—Ç—å?:",
        reply_markup=get_city_keyboard(all_cities, selected_ids)
    )
    await state.set_state(UserStates.waiting_for_city)
    await callback.answer()

# --- –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ---

@router.callback_query(F.data.startswith("notify_heart_"))
async def handle_notify_heart(callback: CallbackQuery, db):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏"""
    try:
        post_id = int(callback.data.split("notify_heart_")[1])
        user_id = callback.from_user.id

        result = await LikeService.toggle_like(db, user_id, post_id)
        is_liked = result["action"] == "added"
        post = await PostService.get_post_by_id(db, post_id)
        post_url = getattr(post, "url", None)

        new_keyboard = get_post_notification_keyboard(
            post_id=post_id, is_liked=is_liked, url=post_url
        )
        await callback.message.edit_reply_markup(reply_markup=new_keyboard)
        action_text = "–¥–æ–±–∞–≤–ª–µ–Ω–æ" if is_liked else "—É–¥–∞–ª–µ–Ω–æ"
        await callback.answer(f"–ò–∑–±—Ä–∞–Ω–Ω–æ–µ {action_text}", show_alert=True)
    except Exception:
        await callback.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ", show_alert=True)


@router.message(F.text == "/delete_user")
async def cmd_delete_user(message: Message, db):
    """–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ—Ö –µ–≥–æ –¥–∞–Ω–Ω—ã—Ö"""
    user_id = message.from_user.id
    logfire.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞")

    user = await UserService.register_user(
        db=db,
        telegram_id=user_id,
        username=message.from_user.username,
        first_name=message.from_user.first_name,
        last_name=message.from_user.last_name,
    )
    if not user:
        await message.answer("–í–∞—à –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ —É–¥–∞–ª—ë–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
        return

    success = await UserService.delete_user(db, user_id)
    if success:
        await message.answer(
            "‚úÖ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–æ—Å—Ç—ã, –ª–∞–π–∫–∏) —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.\n\n"
            "–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –∫–æ–º–∞–Ω–¥–æ–π /start",
            reply_markup=get_main_keyboard()
        )
    else:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

# –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê –î–õ–Ø –ê–î–ú–ò–ù–ê
@router.message(F.text.startswith("/broadcast ") & (F.from_user.id == ADMIN_USER_ID))
async def cmd_broadcast(message: Message, db):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)"""
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
    original_text = message.text[len("/broadcast "):].strip()
    
    if not original_text:
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /broadcast")
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "–ö–æ–º–∞–Ω–¥–∞ ¬´–°–µ—Ä–¥—Ü–∞¬ª:" –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∂–∏—Ä–Ω—ã–º
    broadcast_text = f"<b>–ö–æ–º–∞–Ω–¥–∞ ¬´–°–µ—Ä–¥—Ü–∞¬ª:</b>\n\n{original_text}"

    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    confirm_msg = await message.answer(f"‚è≥ –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è...\n\n{broadcast_text}", parse_mode="HTML")
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    users = await UserService.get_all_users(db)
    
    if not users:
        await confirm_msg.edit_text("‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.")
        return

    total_users = len(users)
    success_count = 0
    fail_count = 0
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    for user in users:
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å HTML-—Ä–∞–∑–º–µ—Ç–∫–æ–π
            await message.bot.send_message(chat_id=user.id, text=broadcast_text, parse_mode="HTML")
            success_count += 1
            # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram
            await asyncio.sleep(0.05) 
        except TelegramForbiddenError:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
            logfire.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞, –Ω–µ –º–æ–≥—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ")
            fail_count += 1
        except TelegramRetryAfter as e:
            # –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤, –∂–¥–µ–º
            logfire.warning(f"–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ Telegram, –∂–¥—É {e.retry_after} —Å–µ–∫—É–Ω–¥")
            await asyncio.sleep(e.retry_after)
            # –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                await message.bot.send_message(chat_id=user.id, text=broadcast_text, parse_mode="HTML")
                success_count += 1
            except Exception as e2:
                logfire.error(f"–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}: {e2}")
                fail_count += 1
        except Exception as e:
            logfire.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}: {e}")
            fail_count += 1
            
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (success_count + fail_count) % 10 == 0 or (success_count + fail_count) == total_users:
            try:
                await confirm_msg.edit_text(
                    f"‚è≥ –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...\n"
                    f"–ü—Ä–æ–≥—Ä–µ—Å—Å: {success_count + fail_count}/{total_users}\n"
                    f"–£—Å–ø–µ—à–Ω–æ: {success_count}\n"
                    f"–û—à–∏–±–æ–∫: {fail_count}\n\n"
                    f"{broadcast_text}",
                    parse_mode="HTML"
                )
            except Exception:
                pass # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ

    # –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
    await confirm_msg.edit_text(
        f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n"
        f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n"
        f"–£—Å–ø–µ—à–Ω–æ: {success_count}\n"
        f"–û—à–∏–±–æ–∫: {fail_count}\n\n"
        f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:\n{broadcast_text}",
        parse_mode="HTML"
    )

# –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö
@router.message(F.text == "/delete_post")
async def cmd_delete_post(message: Message, db):
    """–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –ø–æ ID"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ ID –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
        if len(message.text.split()) < 2:
            await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /delete_post <id>")
            return
            
        post_id = int(message.text.split()[1])
    except (IndexError, ValueError):
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /delete_post <id>")
        return

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞
    post = await PostService.get_post_by_id(db, post_id)
    if not post:
        await message.answer("‚ùå –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º –ø–æ—Å—Ç–∞
    if post.author_id != message.from_user.id:
        await message.answer("‚ùå –í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ø–æ—Å—Ç—ã.")
        return

    # –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç
    success = await PostService.delete_post(db, post_id)
    if success:
        await message.answer(f"‚úÖ –ü–æ—Å—Ç —Å ID {post_id} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.")
    else:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞.")

# –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö
@router.message(F.text == "/liked_posts")
async def cmd_liked_posts(message: Message, db):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /liked_posts ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ"""
    logfire.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–µ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É")
    
    try:
        await message.delete()
    except Exception:
        pass

    if LIKED_GIF_ID:
        try:
            sent = await message.answer_animation(
                animation=LIKED_GIF_ID,
                caption="‚ù§Ô∏è –ó–∞–≥—Ä—É–∂–∞—é –∏–∑–±—Ä–∞–Ω–Ω–æ–µ...",
                parse_mode="HTML"
            )
            await show_liked_page_from_animation(sent, 0, db, user_id=message.from_user.id)
            return
        except Exception as e:
            logfire.warning(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–∏—Ñ–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ: {e}")

    posts = await PostService.get_liked_posts(db, message.from_user.id, POSTS_PER_PAGE, 0)
    if not posts:
        await message.answer(
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π\n"
            "–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å:\n"
            "‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ –≤ –ø–æ–¥–±–æ—Ä–∫–µ\n"
            "‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–æ–¥—Ä–æ–±–Ω–µ–µ —Å–æ–±—ã—Ç–∏—è\n"
            "‚Ä¢ –ù–∞–∂–º–∏—Ç–µ ¬´–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª –ø–æ–¥ –ø–æ—Å—Ç–æ–º",
            reply_markup=get_main_keyboard(),
            parse_mode="HTML"
        )
        return

    total_posts = await PostService.get_liked_posts_count(db, message.from_user.id)
    total_pages = (total_posts + POSTS_PER_PAGE - 1) // POSTS_PER_PAGE
    text = format_liked_list(posts, 1, total_posts)

    await message.answer(
        text,
        reply_markup=get_liked_list_keyboard(posts, 0, total_pages, start_index=1),
        parse_mode="HTML"
    )

@router.message(F.text == "/my_posts")
async def cmd_my_posts(message: Message, db):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /my_posts"""
    posts = await PostService.get_user_posts(db, message.from_user.id)

    if not posts:
        await message.answer("üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤.", reply_markup=get_main_keyboard())
        return

    response = "üìä –í–∞—à–∏ –ø–æ—Å—Ç—ã:\n\n"
    for post in posts:
        await db.refresh(post, attribute_names=["categories", "cities"])
        status = "‚úÖ –û–¥–æ–±—Ä–µ–Ω" if post.is_approved else "‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏"
        category_str = get_clean_category_string(post.categories)
        city_names = ", ".join([c.name for c in post.cities])
        response += f"üìù {post.title}\n"
        response += f"üèôÔ∏è {city_names}\n"
        response += f"üìÇ {category_str}\n"
        response += f"üìÖ {post.created_at.strftime('%d.%m.%Y %H:%M')}\n"
        response += f"üìä {status}\n\n"

    await message.answer(response, reply_markup=get_main_keyboard())


@router.message(F.text == "/change_university")
async def cmd_change_city(message: Message, state: FSMContext, db):
    all_cities = await CityService.get_all_cities(db)
    user_cities = await UserService.get_user_cities(db, message.from_user.id)
    selected_ids = [c.id for c in user_cities]
    
    await state.update_data(selected_cities=selected_ids)
    
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏:",
        reply_markup=get_city_keyboard(all_cities, selected_ids)
    )
    await state.set_state(UserStates.waiting_for_city)


@router.message(F.text == "/change_category")
async def cmd_change_category(message: Message, state: FSMContext, db):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /change_category"""
    categories = await CategoryService.get_all_categories(db)
    user_categories = await UserService.get_user_categories(db, message.from_user.id)
    selected_ids = [cat.id for cat in user_categories]

    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏:",
        reply_markup=get_category_selection_keyboard(categories, selected_ids),
    )
    await state.set_state(UserStates.waiting_for_categories)

# –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö
@router.message(F.text == "/help")
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = """–°–ø—Ä–∞–≤–∫–∞ –ø–æ –°–µ—Ä–¥—Ü—É. –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

üíå –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é - /menu

üìÆ –°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥–±–æ—Ä–∫—É - —Å–ø–∏—Å–æ–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –∏ –≥–æ—Ä–æ–¥—É

‚ù§Ô∏è –ú–æ–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ - —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π

üìù –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ - –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ –°–µ—Ä–¥—Ü–µ

‚≠êÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ - —Å–º–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏

üéì –ò–∑–º–µ–Ω–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç - —Å–º–µ–Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏

–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

1. –í—ã–±–µ—Ä–∏—Ç–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç(—ã)
2. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏
3. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ –ø—Ä–æ–¥–≤–∏–≥–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
4. –ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö –ø–æ –≤–∞—à–∏–º –≤—É–∑–∞–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º

–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞:

‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫: –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤
‚Ä¢ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: –¥–æ 2000 —Å–∏–º–≤–æ–ª–æ–≤
‚Ä¢ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç –º–æ–¥–µ—Ä–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π

–ü–æ –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É @serdce_help
"""

    await message.answer(help_text, reply_markup=get_main_keyboard())


@router.callback_query(F.data == "change_category")
async def change_category_callback(callback: CallbackQuery, state: FSMContext, db):
    """–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É"""
    categories = await CategoryService.get_all_categories(db)
    user_categories = await UserService.get_user_categories(db, callback.from_user.id)
    selected_ids = [cat.id for cat in user_categories]

    try:
        await callback.message.delete()
    except Exception:
        pass
        
    await callback.message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –¥–ª—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏:",
        reply_markup=get_category_selection_keyboard(categories, selected_ids),
    )
    await state.set_state(UserStates.waiting_for_categories)
    await callback.answer()


@router.callback_query(F.data == "my_posts")
async def show_my_posts_callback(callback: CallbackQuery, db):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É"""
    posts = await PostService.get_user_posts(db, callback.from_user.id)

    try:
        await callback.message.delete()
    except Exception:
        pass

    if not posts:
        await callback.message.answer("üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤.", reply_markup=get_main_keyboard())
        return

    response = "üìä –í–∞—à–∏ –ø–æ—Å—Ç—ã:\n\n"
    for post in posts:
        await db.refresh(post, attribute_names=["categories", "cities"])
        status = "‚úÖ –û–¥–æ–±—Ä–µ–Ω" if post.is_approved else "‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏"
        category_str = get_clean_category_string(post.categories)
        city_names = ", ".join([c.name for c in post.cities])
        response += f"üìù {post.title}\n"
        response += f"üèôÔ∏è {city_names}\n"
        response += f"üìÇ {category_str}\n"
        response += f"üìÖ {post.created_at.strftime('%d.%m.%Y %H:%M')}\n"
        response += f"üìä {status}\n\n"
    
    await callback.message.answer(response, reply_markup=get_main_keyboard())
    await callback.answer()

# –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö
@router.callback_query(F.data == "help")
async def show_help_callback(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É"""
    help_text = """–°–ø—Ä–∞–≤–∫–∞ –ø–æ –°–µ—Ä–¥—Ü—É. –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

üíå –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é - /menu

üìÆ –°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥–±–æ—Ä–∫—É - —Å–ø–∏—Å–æ–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –∏ –≥–æ—Ä–æ–¥—É

‚ù§Ô∏è –ú–æ–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ - —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π

üìù –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ - –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ –°–µ—Ä–¥—Ü–µ

‚≠êÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ - —Å–º–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏

üéì –ò–∑–º–µ–Ω–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç - —Å–º–µ–Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏

–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

1. –í—ã–±–µ—Ä–∏—Ç–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç(—ã)
2. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –ø–æ–¥–±–æ—Ä–∫–∏
3. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ –ø—Ä–æ–¥–≤–∏–≥–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
4. –ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö –ø–æ –≤–∞—à–∏–º –≤—É–∑–∞–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º

–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞:

‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫: –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤
‚Ä¢ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: –¥–æ 2000 —Å–∏–º–≤–æ–ª–æ–≤
‚Ä¢ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç –º–æ–¥–µ—Ä–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π

–ü–æ –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É @serdce_help
"""

    try:
        await callback.message.delete()
        await callback.message.answer(help_text, reply_markup=get_main_keyboard())
    except Exception as e:
        if "message is not modified" not in str(e):
            raise
    await callback.answer()
